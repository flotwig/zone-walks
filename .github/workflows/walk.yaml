# NOTE: this file is autogenerated, see `update-walkable-zones.yaml` and `walk.yaml.template`

name: 'Walk zones'

on:
  push:
    branches:
      - main

jobs:
  walk:
    if: "contains(github.event.head_commit.message, 'Update walkable zones')"
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        zone:
        - amazon
        - aquarelle
        - arpa
        - audio
        - auto
        - ax
        - bd
        - br
        - bt
        - car
        - cars
        - ch
        - christmas
        - ci
        - desi
        - diet
        - dz
        - ee
        - er
        - flowers
        - game
        - gdn
        - gn
        - guitars
        - hosting
        - id
        - ieee
        - kg
        - kz
        - lb
        - li
        - lk
        - lol
        - lr
        - mc
        - md
        - mom
        - nu
        - omega
        - pics
        - pr
        - ruhr
        - se
        - shell
        - swatch
        - tn
        - tz
        - ve
        - wed
        - xn--54b7fta0cc
        - xn--80ao21a
        - xn--fzc2c9e2c
        - xn--l1acc
        - xn--pgbs0dh
        - xn--xkc2al3hye2a
    steps:
    - uses: actions/checkout@v3
      with:
        ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
        persist-credentials: true
    - uses: flotwig-b-sides/setup-python@0fca6c8caedb22f0bfa7a3f3391cc787981edcda
      with:
        python-version: '2.7'
        cache: 'pip'
        cache-build: true
    - run: pip install -r requirements.txt
    - run: sudo apt-get install libgetdns-dev
    - run: npx https://github.com/flotwig/zone-walker ${{ matrix.zone }} | sort -u > ./lists/${{ matrix.zone }}.txt
    - run: git pull
    - run: ./build-stats.sh
    - name: Commit files
      run: |
        git config --local user.email "zone-walks@chary.us"
        git config --local user.name "Zone Walks GitHub Action"
        git add lists stats.json README.md
        git commit -m "${{ matrix.zone }} zone walk ($(date -u +"%x %H:%M"))" || exit 0
        git pull --rebase
        git push || (git pull --rebase && git push) || (sleep 15 && git pull --rebase && git push) || (sleep 30 && git pull --rebase && git push)
